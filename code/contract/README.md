## 1 Initialization

### 1.1 Installation
```
$ npm install 
```
or
```
$ yarn
```
install all packages we need.


### 1.2 Set env && secret
.env file will be read to set env like this:
```
NFT_NAME="MetaForest"
NFT_SYMBOL="MFT"
NFT_BASE_URL="https://meta-forest.com/"
MAX_NFT_CAN_BUY=8000
PRICE=300000000000000
ADMIN_USER="0x85FCaa731b57f27C03E631592DCc697F4917c358"
```
.secret file will be read to set accounts.

### 1.3 Compile
```
truffle compile --all
```
compile all contracts in contract folder.

### 1.4 Migration
```
truffle migrate
```
the command line will deploy you contract according to your script file in migrations.

### 1.5 Test
```
truffle test ./test/***.js
```
In the test file directory, you can write javascript scripts to suit your needs. You can run the script file to check the functionality.


### 1.6 Network Config
in truffle.config.js, you can find networks. If you want to add new network, just like this:
```
localhost: {
    network_id: "*",       // Any network (default: none)
    provider: () => new HDWalletProvider(privateKeys, `http://localhost:8545`),
}
```
notice, PrivateKeys are read from the.secret file.So you need to write some private keys in .secret file.Don't worry, this file will not be leaked, and no one will get your account private key.


## 2 Contract introduction
### 2.1 Architecture
![](https://gitlab.fuxi.netease.com:8081/innovative-business/meta-forest/meta-forest-eth-shanghai-hackathon/-/blob/master/metaforest_uml.png)

### 2.2 Overview
Firstly we created CarbonEmission basic protocol, this protocol record the carbon emission generated by user transaction on blockchains;
then we created Meta Forest game based on Carbon Emission. Meta Forest is a binary smart contract combined with varies contracts, contain basic protocol: AccessControl, CarbonEnergy, Tree; and the core contract is MetaForestCore;

#### 2.2.1 CarbonEmission
count the carbon emission on blockchains which generated by user account transactions 

#### 2.2.2 MetaForestCore
define the core logic of low carbon game, with gameplay including trees adoption, donation, water, toxic bomb attack etc.;

#### 2.2.3 AccessControl
realize flexible authority permission proposal based on roles, secure access to contracts

#### 2.2.4 CarbonEnergy
it is a standard ERC20 token contract, CarbonEnergyToken（CET）could be circulated freely among users. 

#### 2.2.5 Tree
it is a standard ERC721 NFT contract<br>

### 2.3 Metadata
We saved all the metadata of NFT trees on IPFS, CID index as below:<br>

|  | Normal tree image | Normal tree json | Legend tree image | Legend tree json |
| ------ | ------ | ------ | ------ | ------ |
| withered | https://ipfs.io/ipfs/QmSJvexQZuVKgGGMoo6b8k7EmvTKbU7Yum98arsinfv3Zi | https://ipfs.io/ipfs/QmPoZY4P2h9w9zVdwvXaNjbZLyRXK13Lcs8x7XNg2uZLVY | https://ipfs.io/ipfs/QmQdSs91tJwEPjddTXFqKyvtyviauKKcqeMQf5oqTzmoPK | https://ipfs.io/ipfs/QmXK7pAZAdNf1rw9JwmMxi3NDQFhahpLTJEkXTBVLTEkhW |  
| small | https://ipfs.io/ipfs/QmNQJqkmPTAUH3MkLxDEQhgMhnoqwbxT2pXvCHoZ9sNKQn | https://ipfs.io/ipfs/QmTfPxh8gYv6scQFCQ4SFfhQcdBK9FQYVHNRjC5moT4RAz | https://ipfs.io/ipfs/QmfMECvoDq7bvc3z88pXQGRVdWdr6PMsFXkyW7x7rwneRA | https://ipfs.io/ipfs/QmWf9XQWNs8Gcg8j3GpyK7s5k2ox9WMzWsTVGTG8HBmDt1 |  
| medium | https://ipfs.io/ipfs/Qme8c5doQMvbkT3Ukn4h5xQH7xhZmftGPjbRPgQCbdcxan | https://ipfs.io/ipfs/QmWFrta4mtKCBYqXEjG4wegm6yV7ACJXVAWy7i1thEcTh8 | https://ipfs.io/ipfs/QmV2MXg6gGycVAvdf2tUP781byCyKDk5UD8nviW3TfySfM | https://ipfs.io/ipfs/QmUTYZ3c4WvgyNzxCXnLLBpAV4HU9SgGUsBB7g7RTsckuA |  
| large | https://ipfs.io/ipfs/QmW9UtfasK1M3HjtUhazxxyAmHCJWMLLhWwaxyVzwciSji | https://ipfs.io/ipfs/QmcUEWtgsE9z77fRaPFxsQ9vB2Dahh6kVk4LwRt64U8HrX | https://ipfs.io/ipfs/QmNhtNR4AuyRjhf1vWMTmrPu2UUWfyY39VxFirSrUSvexu | https://ipfs.io/ipfs/QmaPmPeFeim9j1QibZc9aJq3VidGr4ioHcCpGkjKUkTjm5 |

## 3 Main functions introduction
Internal functions can be viewed in the Meta Forest Github repository. This chapter introduces the main external functions of each contract.<br>

#### 3.1 CarbonEmission
#### 1、 function increaseCarbonEmissions(address user, uint256 amount) public onlyAdmin(msg.sender)<br>
Explanation: Add carbon emissions to a designated account. Every 6600 blocks, you can only add carbon emissions once at most. This interface is used by oracle machines. Carbon Emission Certification Alliance members reach a consensus on the carbon emissions generated by transactions in each account every day. After that, upload it to the protocol through the oracle machine<br>
Restriction: This interface requires admin privileges<br>  
##### 2、function totalBalanceOf(address account) public view  returns (uint256)<br>   
Explanation: Get the user's total carbon emissions<br>
##### 3、function lastBalanceOf(address account) public view  returns (uint256)<br>
Explanation: Get the user's carbon emissions yesterday. Value will return 0 if nearly 6600 blocks tall does not add carbon emissions<br>   
##### 4、function lastUpdateOf(address account) public view  returns (uint256)<br>
Explanation: Get the block height of the latest carbon emission update<br>

#### 3.2 AccessControl
##### 1、function removeRoleUser(string[] calldata modifierRoles, address[] calldata RoleUsers) external onlyRole(_roles["ADMIN_USER"]<br>
Explanation: Batch delete role permissions<br>
Restriction: This interface requires admin authourity<br>
##### 2、function addRoleUser(string[] calldata modifierRoles, address[] calldata newRoleUsers) external onlyRole(_roles["ADMIN_USER"])<br>
Explanation: Add role permissions in batches<br>
Restriction: This interface requires admin privileges<br>

#### 3.3 CarbonEnergy
 ##### 1、function mint(address account, uint256 amount) external onlyAdmin(msg.sender)<br>
 Explanation: Mint the specified amount of CET to the specified user, in the game users can get CET by walking and donating trees<br>
 Restriction: This interface requires admin privileges<br>
 ##### 2、function burn(address account, uint256 amount) public<br>
 Explanation: Destroy the specified number of CETs specified by the user for the watering gameplay in the game<br>
 Restriction: This user is required to authorize CET to the operator<br>

#### 3.4 Tree
##### 1、function tokenURI(uint256 tokenId) public view virtual override validTokenId(tokenId) returns (string memory)<br>

Explanation: Query the URI of the specified token<br>
##### 2、function tokenListOfOwner(address user, uint256 queryIndex) external view returns (uint256[] memory, bool)<br>

Explanation: query all the tokens of the specified user, when the number of tokens is greater than 10, it will be returned in the form of pagination<br>
##### 3、function mint(address to, uint256 tokenId) external onlyAdminOrMaster(msg.sender) onlyValidAddress(to)<br>

Explanation: Mint a specific token to the specified user<br>
Restriction: This interface requires admin or master privileges<br>

#### 3.5 MetaForestCore
##### 1、function buy(uint16 count) external payable<br>
 Explanation: Buy Prestige TREE-NFT<br>
 Restriction: Token value to be paid = count*price; when the token is less than count*price, the purchase will fail<br>
##### 2、function setPrice(uint80 price) external onlyAdmin<br>
 Explanation: Set the price of the noble TREE-NFT, this interface is used by Meta Forest DAO<br>
 Restriction: This interface requires admin privileges<br>
##### 3、function getFreeNFT() external onlyOnce<br>
 Explanation: Claim a free NFT<br>
 Limit: One account limit once<br>
##### 4、function takeOutNativeToken(address payable to, uint256 amount) external onlyOwner(msg.sender)<br>
 Explanation: withdraw the MATIC collected in the contract to an account, this interface is used by Meta Forest DAO, and donate to community-approved carbon reduction projects<br>
 Restriction: Project owner permission is required<br>
##### 5、function watering(uint256 tokenId, uint256 wateringAmount) external<br>
 Explanation: Users destroy their own carbon energy CET to water the specified tree, increase the growth value of the tree or restore the health of the tree<br>
 Restriction: Users are required to authorize their CET to the MetaForestCore contract in advance<br>
##### 6、function attack(address account, uint256 tokenId, uint256 amount) external<br>
 Explanation: When the user generates carbon emissions, other users can transfer the user's carbon emissions to the user's tree within a specified time (6600 blocks high) to make the tree sick; beyond the specified time (6600 blocks high), the gas bomb will fail , cannot be ignited<br>

##### 7、function getGrowthAmount(uint256 tokenId) external view returns (uint256)<br>
 Explanation: Query the growth value of the specified tree, watering can increase the value<br>
##### 8、function getUnhealthyAmount(uint256 tokenId) external view returns (uint256)<br>
 Explanation: Query the unhealthy value of the specified tree, attacking can increase the value, watering can reduce the value <br>
##### 9、function getAttackAmount(address account) external view returns (uint256)<br>
 Explanation: Query the carbon emissions of the specified user within the specified time (6600 blocks), which can be used to attack the user's tree<br>
